{% extends "base.html" %}
{% block nav_avisos %}active{% endblock %}
{% block page_title %}Enviar Avisos{% endblock %}
{% block page_icon %}<i class="bi bi-megaphone"></i>{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-8 col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-primary">
                    <i class="bi bi-megaphone-fill"></i> Enviar Aviso em Massa
                </h5>
                <small class="text-muted">Envie mensagens via WhatsApp para seus clientes</small>
            </div>
            
            <div class="card-body">
                <form method="POST" action="/enviar-aviso" id="formAviso">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label for="tipo" class="form-label">
                                <i class="bi bi-people text-primary"></i> 
                                Público-alvo <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="">Selecione o público</option>
                                <option value="ativos">Apenas clientes ATIVOS</option>
                                <option value="a_vencer">A vencer (Próximos 7 dias)</option>
                                <option value="expirados">Apenas clientes EXPIRADOS</option>
                                <option value="personalizado">Personalizado (Selecionar clientes)</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <label class="form-label">
                                <i class="bi bi-bar-chart text-info"></i> 
                                Estimativa de Envios
                            </label>
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <div id="estimativaEnvios" class="text-center">
                                        <span class="text-muted">Selecione um público</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4" id="container-personalizado" style="display: none;">
                        <label for="clientes_selecionados" class="form-label">
                            <i class="bi bi-person-check text-primary"></i>
                            Selecione os Clientes <span class="text-danger">*</span>
                        </label>
                        <select id="clientes_selecionados" name="clientes_selecionados" multiple placeholder="Digite para buscar por nome, usuário ou telefone..."></select>
                    </div>

                    <input type="hidden" id="nomeTemplateSelecionado" name="nome_template" value="">
                    <div class="mb-4">
                        <label for="mensagem" class="form-label">
                            <i class="bi bi-chat-text text-primary"></i> 
                            Mensagem <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="mensagem" name="mensagem" rows="8" 
                                  placeholder="Digite sua mensagem aqui ou escolha um template abaixo..." required maxlength="4000"></textarea>
                        <div class="d-flex justify-content-between">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> 
                                Variáveis: {{ '{{nome_cliente}}' }}, {{ '{{nome_lista}}' }}, {{ '{{data_vencimento}}' }}, {{ '{{dias_restantes}}' }}
                            </div>
                            <small class="text-muted">
                                <span id="contadorCaracteres">0</span>/4000 caracteres
                            </small>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="limparFormulario()">
                            <i class="bi bi-arrow-clockwise"></i> Limpar
                        </button>
                        <button type="submit" class="btn btn-primary" id="btnEnviar">
                            <i class="bi bi-send"></i> Enviar Aviso
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-secondary">
                    <i class="bi bi-file-text"></i> Templates de Aviso
                </h6>
                <a href="{{ url_for('gerenciar_templates_page') }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-gear"></i> Gerenciar Templates
                </a>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Clique em um template para carregar o texto na mensagem:</p>
                <div class="row g-2">
                    {% for template in templates %}
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start template-btn"
                                data-template-name="{{ template.nome }}"
                                data-template-body="{{ template.corpo }}">
                            <i class="bi bi-file-earmark-text"></i> {{ template.nome | replace("_", " ") | title }}
                        </button>
                    </div>
                    {% else %}
                    <p class="text-muted">Nenhum template disponível.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- INICIALIZAÇÃO DO TOM SELECT ---
    let tomSelect = null;

    async function inicializarTomSelect() {
        try {
            const response = await fetch('/api/clientes/para_selecao');
            if (!response.ok) throw new Error('Falha ao carregar clientes');
            const clientes = await response.json();

            tomSelect = new TomSelect('#clientes_selecionados', {
                valueField: 'id',
                labelField: 'nome',
                searchField: ['nome', 'usuario_iptv', 'telefone'],
                options: clientes,
                create: false,
                render: {
                    item: function(data, escape) {
                        return `<div>
                                    <span class="fw-bold">${escape(data.nome || data.usuario_iptv)}</span>
                                    <small class="text-muted ms-2">(${escape(data.usuario_iptv)})</small>
                                </div>`;
                    },
                    option: function(data, escape) {
                        return `<div>
                                    <span class="fw-bold">${escape(data.nome || data.usuario_iptv)}</span>
                                    <small class="d-block text-muted">${escape(data.usuario_iptv)} | ${escape(data.telefone)}</small>
                                </div>`;
                    }
                }
            });
        } catch (error) {
            console.error("Erro ao carregar clientes para o seletor:", error);
        }
    }
    inicializarTomSelect();

    // --- LÓGICA DO FORMULÁRIO ---
    const tipoSelect = document.getElementById('tipo');
    const containerPersonalizado = document.getElementById('container-personalizado');
    const estimativaDiv = document.getElementById('estimativaEnvios');
    const mensagemTextarea = document.getElementById('mensagem');
    
    tipoSelect.addEventListener('change', async function() {
        const tipo = this.value;

        containerPersonalizado.style.display = (tipo === 'personalizado') ? 'block' : 'none';

        if (!tipo) {
            estimativaDiv.innerHTML = '<span class="text-muted">Selecione um público</span>';
            return;
        }
        
        estimativaDiv.innerHTML = '<span class="text-muted">Calculando...</span>';
        try {
            const response = await fetch(`/api/contar-clientes/${tipo}`);
            if (!response.ok) throw new Error('Falha ao calcular estimativa');
            const data = await response.json();

            let texto = `${data.count || 0} cliente(s)`;
            if (tipo === 'a_vencer') texto += ' a vencer';
            if (tipo === 'expirados') texto += ' expirado(s)';
            
            estimativaDiv.innerHTML = `<strong class="text-primary">${texto}</strong>`;
        } catch (error) {
            console.error("Erro na estimativa:", error);
            estimativaDiv.innerHTML = '<span class="text-danger">Erro ao calcular</span>';
        }
    });

    mensagemTextarea.addEventListener('input', function() {
        document.getElementById('contadorCaracteres').textContent = this.value.length;
    });

    document.getElementById('formAviso').addEventListener('submit', function(e) {
        if (tipoSelect.value === 'personalizado' && tomSelect && tomSelect.getValue().length === 0) {
            alert('Por favor, selecione pelo menos um cliente para o envio personalizado.');
            e.preventDefault();
        }
    });
    
    // *** CORREÇÃO APLICADA AQUI ***
    // Adiciona o listener para os botões de template
    document.querySelectorAll('.template-btn').forEach(button => {
        button.addEventListener('click', function() {
            const nome = this.dataset.templateName;
            const corpo = this.dataset.templateBody;
            usarTemplate(nome, corpo);
        });
    });
});

// Função para usar o template (agora chamada pelo listener)
function usarTemplate(nome, corpo) {
    const mensagemTextarea = document.getElementById('mensagem');
    mensagemTextarea.value = corpo;
    mensagemTextarea.dispatchEvent(new Event('input')); // Atualiza o contador de caracteres
    document.getElementById('nomeTemplateSelecionado').value = nome;
    mensagemTextarea.focus();
}

function limparFormulario() {
    document.getElementById('formAviso').reset();
    document.getElementById('tipo').dispatchEvent(new Event('change'));
    document.getElementById('mensagem').dispatchEvent(new Event('input'));
    // Limpa também o seletor TomSelect se ele existir
    const tomSelect = document.getElementById('clientes_selecionados').tomselect;
    if(tomSelect) {
        tomSelect.clear();
    }
}
</script>
{% endblock %}